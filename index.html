<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASMETO 2026 - Gestor de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .bg-pitch { background-color: #2d5a27; }
        .card-player { transition: all 0.2s; }
        .card-player:active { transform: scale(0.98); }
        .suspended { filter: grayscale(1); opacity: 0.6; border: 2px solid #ef4444 !important; }
        .video-container { width: 100%; max-width: 320px; border-radius: 8px; overflow: hidden; }
        #camera-preview { width: 100%; transform: scaleX(-1); }
    </style>
</head>
<body class="pb-20">

    <!-- Navega√ß√£o Superior -->
    <nav class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tighter">ASMETO 2026</h1>
            <div id="nav-status" class="text-sm font-medium bg-indigo-800 px-3 py-1 rounded-full">
                Sess√£o: <span id="current-session-name">Nenhuma</span>
            </div>
        </div>
    </nav>

    <!-- Container Principal -->
    <main class="container mx-auto p-4 max-w-4xl">

        <!-- Menu de Abas -->
        <div class="flex space-x-2 mb-6 overflow-x-auto pb-2">
            <button onclick="showTab('tab-sessao')" class="tab-btn active bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">Sess√£o</button>
            <button onclick="showTab('tab-atletas')" class="tab-btn bg-white text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold border">Atletas</button>
            <button onclick="showTab('tab-jogo')" class="tab-btn bg-white text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold border">Jogo</button>
            <button onclick="showTab('tab-ranking')" class="tab-btn bg-white text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold border">Ranking</button>
        </div>

        <!-- ABA 1: GEST√ÉO DE SESS√ÉO -->
        <section id="tab-sessao" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                <h2 class="text-lg font-bold mb-4">Nova Sess√£o / Hist√≥rico</h2>
                <div class="flex flex-col gap-4">
                    <input type="text" id="session-name-input" placeholder="Ex: Pelada de Quarta" class="p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    <button onclick="createSession()" class="bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">CRIAR SESS√ÉO</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-4 flex justify-between items-center">
                    Hist√≥rico Local
                    <button onclick="exportHistoryCSV()" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Baixar CSV</button>
                </h3>
                <div id="history-list" class="space-y-3">
                    <p class="text-gray-500 text-sm text-center">Nenhuma sess√£o registrada.</p>
                </div>
            </div>
        </section>

        <!-- ABA 2: ATLETAS E PRESEN√áA -->
        <section id="tab-atletas" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                <h2 class="text-lg font-bold mb-4">Cadastro de Atleta</h2>
                <div class="space-y-4">
                    <div class="flex flex-col items-center">
                        <div class="video-container bg-black aspect-video mb-2 flex items-center justify-center relative">
                            <video id="camera-preview" autoplay playsinline class="hidden"></video>
                            <canvas id="photo-canvas" class="hidden"></canvas>
                            <img id="photo-preview" src="" class="hidden w-full h-full object-cover">
                            <div id="camera-placeholder" class="text-white text-xs text-center p-4">C√¢mera desativada</div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="btn-start-camera" onclick="startCamera()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">Ligar C√¢mera</button>
                            <button id="btn-capture" onclick="capturePhoto()" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg text-sm font-medium hidden">Tirar Foto</button>
                        </div>
                    </div>
                    <input type="text" id="player-name-input" placeholder="Nome Completo do Atleta" class="w-full p-3 border rounded-lg">
                    <button onclick="registerPlayer()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg">CADASTRAR E CONFIRMAR</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Confirmados para Hoje</h3>
                    <button onclick="drawTeams()" class="bg-green-600 text-white text-sm px-4 py-2 rounded-lg font-bold">SORTEAR TIMES</button>
                </div>
                <div class="mb-4">
                    <label class="text-xs text-gray-500 block mb-1">Jogadores por Equipa:</label>
                    <input type="number" id="players-per-team" value="7" min="2" class="p-2 border rounded-lg w-20">
                </div>
                <div id="attendance-list" class="space-y-2">
                    <!-- Lista de Presen√ßa Din√¢mica -->
                </div>
            </div>
        </section>

        <!-- ABA 3: MATCH DAY (JOGO) -->
        <section id="tab-jogo" class="tab-content hidden">
            <!-- Cron√¥metro e Placar -->
            <div class="bg-pitch text-white p-6 rounded-xl shadow-lg mb-6 text-center">
                <div class="flex justify-around items-center mb-4">
                    <div class="flex flex-col items-center">
                        <span class="text-xs uppercase font-bold opacity-80">Equipa A</span>
                        <div id="score-a" class="text-5xl font-black">0</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="timer-display" class="text-4xl font-mono bg-black/30 px-4 py-2 rounded-lg mb-2">10:00</div>
                        <div class="flex space-x-2">
                            <button id="timer-ctrl" onclick="toggleTimer()" class="bg-red text-pitch px-4 py-1 rounded-full text-xs font-bold">INICIAR</button>
                            <button onclick="configTimer()" class="bg-white/20 text-white px-3 py-1 rounded-full text-xs">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-xs uppercase font-bold opacity-80">Equipa B</span>
                        <div id="score-b" class="text-5xl font-black">0</div>
                    </div>
                </div>
            </div>

            <!-- Times em Campo -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="space-y-2">
                    <h4 class="text-sm font-bold border-b pb-1 flex justify-between">
                        TIME A <button onclick="addGoal('A')" class="text-indigo-600 bg-white px-2 rounded">+ GOL</button>
                    </h4>
                    <div id="field-a" class="space-y-1"></div>
                </div>
                <div class="space-y-2">
                    <h4 class="text-sm font-bold border-b pb-1 flex justify-between">
                        TIME B <button onclick="addGoal('B')" class="text-indigo-600 bg-white px-2 rounded">+ GOL</button>
                    </h4>
                    <div id="field-b" class="space-y-1"></div>
                </div>
            </div>

            <!-- Fila de Espera -->
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                <h4 class="text-sm font-bold mb-3 uppercase text-gray-500">Pr√≥ximos da Fila (Prioridade)</h4>
                <div id="waiting-list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Finalizar Partida -->
            <div class="flex space-x-2">
                <button onclick="endMatch('A')" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold">VENCEDOR A</button>
                <button onclick="endMatch('Empate')" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-bold">EMPATE</button>
                <button onclick="endMatch('B')" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold">VENCEDOR B</button>
            </div>

            <!-- Jogadores Punidos (VM) -->
            <div id="punished-container" class="mt-8 hidden">
                <h4 class="text-sm font-bold mb-3 text-red-600 uppercase">Suspensos Tempor√°rios</h4>
                <div id="punished-list" class="space-y-2"></div>
            </div>
        </section>

        <!-- ABA 4: RANKING -->
        <section id="tab-ranking" class="tab-content hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold">Estat√≠sticas Gerais</h2>
                    <button onclick="exportRankingCSV()" class="bg-green-100 text-green-700 text-xs px-3 py-1 rounded font-bold">Exportar CSV</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-2">Atleta</th>
                                <th class="p-2 text-center">GOL</th>
                                <th class="p-2 text-center">AST</th>
                                <th class="p-2 text-center">CA</th>
                                <th class="p-2 text-center">CV</th>
                                <th class="p-2 text-center">VIT</th>
                                <th class="p-2 text-center">APR%</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- MODAL DE REGISTRO DE EVENTOS (Gol/Cart√£o) -->
    <div id="event-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Registrar Gol</h3>
            
            <div id="modal-step-1">
                <p class="text-sm text-gray-500 mb-3" id="modal-instruction">Quem marcou o gol?</p>
                <div id="modal-player-list" class="space-y-2 max-h-60 overflow-y-auto pr-2 mb-4"></div>
            </div>

            <div id="modal-step-2" class="hidden">
                <p class="text-sm text-gray-500 mb-3">Quem deu a assist√™ncia? (Obrigat√≥rio)</p>
                <div id="modal-assist-list" class="space-y-2 max-h-60 overflow-y-auto pr-2 mb-4"></div>
            </div>

            <div class="flex justify-end space-x-2">
                <button onclick="closeModal()" class="text-gray-500 px-4 py-2 font-medium">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Script de Logica -->
    <script>
        // --- Estado Global ---
        let sessions = JSON.parse(localStorage.getItem('asmeto_sessions')) || [];
        let currentSession = null;
        let players = JSON.parse(localStorage.getItem('asmeto_players')) || [];
        let sessionPlayers = []; // Confirmados na sess√£o atual
        let teamA = [];
        let teamB = [];
        let waitingList = [];
        let punishedPlayers = [];
        let stats = JSON.parse(localStorage.getItem('asmeto_stats')) || {}; // {playerId: {gol, ast, ca, cv, vit, games}}
        
        // Cron√¥metro
        let timerSeconds = 480;
        let initialSeconds = 480;
        let timerInterval = null;
        let isTimerRunning = false;

        // Foto Tempor√°ria
        let currentCapturedPhoto = "";

        // --- Inicializa√ß√£o ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white'));
            
            document.getElementById(tabId).classList.remove('hidden');
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            activeBtn.classList.add('active', 'bg-indigo-600', 'text-white');
            
            if(tabId === 'tab-ranking') renderRanking();
            if(tabId === 'tab-sessao') renderSessions();
        }

        // --- Gest√£o de Sess√£o ---
        function createSession() {
            const name = document.getElementById('session-name-input').value;
            if(!name) return showMsg("Insira o nome da sess√£o");
            
            currentSession = {
                id: Date.now(),
                name: name,
                date: new Date().toLocaleDateString(),
                confirmedCount: 0
            };
            sessions.push(currentSession);
            localStorage.setItem('asmeto_sessions', JSON.stringify(sessions));
            
            document.getElementById('current-session-name').innerText = name;
            document.getElementById('session-name-input').value = "";
            sessionPlayers = [];
            renderAttendance();
            showTab('tab-atletas');
        }

        function renderSessions() {
            const container = document.getElementById('history-list');
            if(sessions.length === 0) return;
            container.innerHTML = sessions.map(s => `
                <div class="border p-3 rounded-lg flex justify-between items-center text-sm">
                    <div>
                        <div class="font-bold">${s.name}</div>
                        <div class="text-xs text-gray-500">${s.date} - ${s.confirmedCount} atletas</div>
                    </div>
                    <button onclick="loadSession(${s.id})" class="text-indigo-600 font-bold">Selecionar</button>
                </div>
            `).join('');
        }

        function loadSession(id) {
            currentSession = sessions.find(s => s.id === id);
            document.getElementById('current-session-name').innerText = currentSession.name;
            showTab('tab-atletas');
        }

        // --- Gest√£o de Atletas ---
        async function startCamera() {
            const video = document.getElementById('camera-preview');
            const placeholder = document.getElementById('camera-placeholder');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
                video.classList.remove('hidden');
                placeholder.classList.add('hidden');
                document.getElementById('btn-capture').classList.remove('hidden');
                document.getElementById('btn-start-camera').innerText = "Reiniciar C√¢mera";
            } catch (err) {
                showMsg("Erro ao acessar c√¢mera: " + err.message);
            }
        }

        function capturePhoto() {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('photo-canvas');
            const preview = document.getElementById('photo-preview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            currentCapturedPhoto = canvas.toDataURL('image/jpeg', 0.5);
            preview.src = currentCapturedPhoto;
            preview.classList.remove('hidden');
            video.classList.add('hidden');
            document.getElementById('btn-capture').innerText = "Tentar Novamente";
        }

        function registerPlayer() {
            const name = document.getElementById('player-name-input').value;
            if(!name) return showMsg("Nome √© obrigat√≥rio");
            if(!currentSession) return showMsg("Crie uma sess√£o primeiro");

            const player = {
                id: Date.now().toString(),
                name: name,
                photo: currentCapturedPhoto || "https://ui-avatars.com/api/?name="+name,
                winsInRow: 0
            };

            players.push(player);
            localStorage.setItem('asmeto_players', JSON.stringify(players));
            
            // Inicia estat√≠sticas se novo
            if(!stats[player.id]) {
                stats[player.id] = { gol: 0, ast: 0, ca: 0, cv: 0, vit: 0, games: 0 };
            }

            // Confirma na sess√£o
            sessionPlayers.push(player);
            currentSession.confirmedCount = sessionPlayers.length;
            localStorage.setItem('asmeto_sessions', JSON.stringify(sessions));

            // Se o jogo j√° estiver rolando, quem chega entra no fim da fila
            if(teamA.length > 0) {
                waitingList.push(player);
                renderField();
            }

            // Reset UI
            document.getElementById('player-name-input').value = "";
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('camera-placeholder').classList.remove('hidden');
            currentCapturedPhoto = "";
            
            renderAttendance();
            showMsg("Atleta cadastrado!");
        }

        function renderAttendance() {
            const list = document.getElementById('attendance-list');
            list.innerHTML = sessionPlayers.map(p => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border">
                    <div class="flex items-center space-x-3">
                        <img src="${p.photo}" class="w-10 h-10 rounded-full object-cover border">
                        <span class="font-medium">${p.name}</span>
                    </div>
                    <input type="checkbox" checked class="w-5 h-5 accent-indigo-600">
                </div>
            `).join('');
        }

        // --- L√≥gica de Times ---
        function drawTeams() {
            if(sessionPlayers.length < 4) return showMsg("M√≠nimo de 4 atletas");
            const perTeam = parseInt(document.getElementById('players-per-team').value);
            
            // Sorteio por ordem de cadastro conforme requisito
            const pool = [...sessionPlayers];
            teamA = pool.splice(0, perTeam);
            teamB = pool.splice(0, perTeam);
            waitingList = pool; // Resto vai para fila

            showTab('tab-jogo');
            renderField();
        }

        function renderField() {
            const renderList = (players, containerId) => {
                const div = document.getElementById(containerId);
                div.innerHTML = players.map(p => {
                    const isPunished = punishedPlayers.find(pp => pp.id === p.id);
                    return `
                        <div class="flex items-center justify-between bg-white p-2 rounded shadow-sm border ${isPunished ? 'suspended' : ''}">
                            <div class="flex items-center space-x-2">
                                <img src="${p.photo}" class="w-8 h-8 rounded-full">
                                <span class="text-xs font-bold truncate w-20">${p.name}</span>
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="giveCard('${p.id}', 'amarelo')" class="bg-yellow-400 w-4 h-6 rounded-sm"></button>
                                <button onclick="giveCard('${p.id}', 'vermelho')" class="bg-red-500 w-4 h-6 rounded-sm"></button>
                                <button onclick="substitutePlayer('${p.id}', '${containerId.slice(-1).toUpperCase()}')" class="bg-gray-200 p-1 rounded text-[10px]">üîÉ</button>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            renderList(teamA, 'field-a');
            renderList(teamB, 'field-b');

            // Fila
            const waitingDiv = document.getElementById('waiting-list');
            waitingDiv.innerHTML = waitingList.map(p => `
                <div class="relative group">
                    <img src="${p.photo}" class="w-12 h-12 rounded-lg object-cover border-2 border-indigo-200">
                    <button onclick="removeFromWaiting('${p.id}')" class="absolute -top-2 -right-2 bg-red-500 text-white text-[8px] rounded-full w-4 h-4">X</button>
                </div>
            `).join('');
        }

        // --- Substitui√ß√µes e Fila ---
        function substitutePlayer(playerId, teamLabel) {
            if(waitingList.length === 0) return showMsg("Ningu√©m na fila!");
            
            const next = waitingList.shift();
            if(teamLabel === 'A') {
                const idx = teamA.findIndex(p => p.id === playerId);
                waitingList.push(teamA[idx]); // Jogador que saiu vai pro fim da fila
                teamA[idx] = next;
            } else {
                const idx = teamB.findIndex(p => p.id === playerId);
                waitingList.push(teamB[idx]);
                teamB[idx] = next;
            }
            renderField();
        }

        function removeFromWaiting(id) {
            waitingList = waitingList.filter(p => p.id !== id);
            renderField();
        }

        // --- Match Day ---
        function toggleTimer() {
            const btn = document.getElementById('timer-ctrl');
            if(isTimerRunning) {
                clearInterval(timerInterval);
                btn.innerText = "RETOMAR";
            } else {
                timerInterval = setInterval(() => {
                    if(timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        showMsg("Fim de Jogo!");
                        return;
                    }
                    timerSeconds--;
                    updateTimerUI();
                    updatePunishmentTimers();
                }, 1000);
                btn.innerText = "PAUSAR";
            }
            isTimerRunning = !isTimerRunning;
        }

        function updateTimerUI() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timer-display').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function configTimer() {
            const t = prompt("Definir minutos de jogo:", "10");
            if(t) {
                initialSeconds = parseInt(t) * 60;
                timerSeconds = initialSeconds;
                updateTimerUI();
            }
        }

        function addGoal(teamLabel) {
            const list = teamLabel === 'A' ? teamA : teamB;
            openModal("Registrar Gol", list, (scorerId) => {
                // Step 2: Assistencia
                stats[scorerId].gol++;
                const assistList = list.filter(p => p.id !== scorerId);
                openModal("Assist√™ncia Obrigat√≥ria", assistList, (assisterId) => {
                    stats[assisterId].ast++;
                    if(teamLabel === 'A') {
                        document.getElementById('score-a').innerText = parseInt(document.getElementById('score-a').innerText) + 1;
                    } else {
                        document.getElementById('score-b').innerText = parseInt(document.getElementById('score-b').innerText) + 1;
                    }
                    closeModal();
                }, true);
            });
        }

        function giveCard(playerId, type) {
            if(type === 'amarelo') {
                stats[playerId].ca++;
                // Verifica 2¬∫ amarelo
                const pCA = players.find(p => p.id === playerId);
                pCA.tempCA = (pCA.tempCA || 0) + 1;
                if(pCA.tempCA >= 2) {
                    pCA.tempCA = 0;
                    punishPlayer(playerId, "2¬∫ Amarelo");
                }
            } else {
                stats[playerId].cv++;
                punishPlayer(playerId, "Vermelho");
            }
            renderField();
            localStorage.setItem('asmeto_stats', JSON.stringify(stats));
        }

        function punishPlayer(playerId, reason) {
            const player = players.find(p => p.id === playerId);
            punishedPlayers.push({ ...player, reason, timeLeft: 90 }); // 90 segundos padr√£o
            document.getElementById('punished-container').classList.remove('hidden');
            renderPunished();
        }

        function updatePunishmentTimers() {
            if(punishedPlayers.length === 0) return;
            punishedPlayers.forEach(p => {
                p.timeLeft--;
            });
            const finished = punishedPlayers.filter(p => p.timeLeft <= 0);
            if(finished.length > 0) {
                punishedPlayers = punishedPlayers.filter(p => p.timeLeft > 0);
                showMsg("Jogador retornou da puni√ß√£o");
                renderField();
            }
            renderPunished();
        }

        function renderPunished() {
            const div = document.getElementById('punished-list');
            div.innerHTML = punishedPlayers.map(p => `
                <div class="bg-red-50 p-2 rounded flex justify-between items-center text-xs">
                    <span class="font-bold">${p.name} (${p.reason})</span>
                    <span class="bg-red-600 text-white px-2 py-1 rounded">${p.timeLeft}s</span>
                </div>
            `).join('');
            if(punishedPlayers.length === 0) document.getElementById('punished-container').classList.add('hidden');
        }

        // --- Rota√ß√£o de Vencedores ---
        function endMatch(winner) {
            const scoreA = parseInt(document.getElementById('score-a').innerText);
            const scoreB = parseInt(document.getElementById('score-b').innerText);
            
            // Registra games jogados
            [...teamA, ...teamB].forEach(p => stats[p.id].games++);

            let winningTeam = [];
            let losingTeam = [];

            if(winner === 'A' || (winner === 'Empate' && scoreA > scoreB)) {
                winningTeam = teamA;
                losingTeam = teamB;
            } else if (winner === 'B') {
                winningTeam = teamB;
                losingTeam = teamA;
            } else {
                // Caso empate total, crit√©rio do sistema ou sorteio para manter um
                winningTeam = teamA;
                losingTeam = teamB;
                showMsg("Empate: Time A mantido por padr√£o.");
            }

            // Atribui vit√≥rias
            winningTeam.forEach(p => {
                stats[p.id].vit++;
                p.winsInRow = (p.winsInRow || 0) + 1;
            });
            losingTeam.forEach(p => p.winsInRow = 0);

            // Regra de 3 vit√≥rias seguidas
            const forcedExit = winningTeam.some(p => p.winsInRow >= 3);
            if(forcedExit) {
                showMsg("Time atingiu 3 vit√≥rias e saiu da quadra!");
                waitingList.push(...winningTeam);
                winningTeam.forEach(p => p.winsInRow = 0);
                // Pr√≥ximos dois times da fila entram
                const perTeam = winningTeam.length;
                teamA = waitingList.splice(0, perTeam);
                teamB = waitingList.splice(0, perTeam);
            } else {
                // Perdedor vai pro fim da fila
                waitingList.push(...losingTeam);
                const perTeam = losingTeam.length;
                const nextTeam = waitingList.splice(0, perTeam);
                
                if(winner === 'A') teamB = nextTeam;
                else teamA = nextTeam;
            }

            // Reset Game UI
            document.getElementById('score-a').innerText = "0";
            document.getElementById('score-b').innerText = "0";
            timerSeconds = initialSeconds;
            updateTimerUI();
            localStorage.setItem('asmeto_stats', JSON.stringify(stats));
            renderField();
            showMsg("Partida encerrada. Pr√≥ximos!");
        }

        // --- Ranking ---
        function renderRanking() {
            const body = document.getElementById('ranking-body');
            const sorted = Object.keys(stats).map(id => ({
                id, 
                ...stats[id], 
                name: players.find(p => p.id === id)?.name || 'Ex-Atleta',
                apr: stats[id].games > 0 ? ((stats[id].vit / stats[id].games) * 100).toFixed(1) : 0
            })).sort((a, b) => b.gol - a.gol);

            body.innerHTML = sorted.map(s => `
                <tr class="border-b">
                    <td class="p-2 font-medium">${s.name}</td>
                    <td class="p-2 text-center">${s.gol}</td>
                    <td class="p-2 text-center">${s.ast}</td>
                    <td class="p-2 text-center">${s.ca}</td>
                    <td class="p-2 text-center">${s.cv}</td>
                    <td class="p-2 text-center">${s.vit}</td>
                    <td class="p-2 text-center">${s.apr}%</td>
                </tr>
            `).join('');
        }

        // --- Modais ---
        let modalCallback = null;
        function openModal(title, playerList, callback, isStep2 = false) {
            document.getElementById('event-modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = title;
            const container = isStep2 ? document.getElementById('modal-assist-list') : document.getElementById('modal-player-list');
            
            if(!isStep2) {
                document.getElementById('modal-step-1').classList.remove('hidden');
                document.getElementById('modal-step-2').classList.add('hidden');
            } else {
                document.getElementById('modal-step-1').classList.add('hidden');
                document.getElementById('modal-step-2').classList.remove('hidden');
            }

            container.innerHTML = playerList.map(p => `
                <button onclick="selectModalPlayer('${p.id}')" class="w-full text-left p-3 border rounded-lg hover:bg-indigo-50 flex items-center space-x-3">
                    <img src="${p.photo}" class="w-8 h-8 rounded-full">
                    <span class="font-bold">${p.name}</span>
                </button>
            `).join('');
            modalCallback = callback;
        }

        function selectModalPlayer(id) {
            if(modalCallback) modalCallback(id);
        }

        function closeModal() {
            document.getElementById('event-modal').classList.add('hidden');
            modalCallback = null;
        }

        // --- Exporta√ß√£o CSV ---
        function exportRankingCSV() {
            const headers = "Atleta,Gols,Assist,CA,CV,Vit,Apr%\n";
            const rows = Object.keys(stats).map(id => {
                const s = stats[id];
                const p = players.find(pl => pl.id === id);
                const apr = s.games > 0 ? ((s.vit / s.games) * 100).toFixed(1) : 0;
                return `${p?.name || 'Unknown'},${s.gol},${s.ast},${s.ca},${s.cv},${s.vit},${apr}%`;
            }).join("\n");
            
            downloadCSV("ranking_asmeto.csv", headers + rows);
        }

        function exportHistoryCSV() {
            const headers = "ID,Sess√£o,Data,Atletas\n";
            const rows = sessions.map(s => `${s.id},${s.name},${s.date},${s.confirmedCount}`).join("\n");
            downloadCSV("historico_asmeto.csv", headers + rows);
        }

        function downloadCSV(filename, content) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showMsg(msg) {
            const toast = document.createElement('div');
            toast.className = "fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm z-50 shadow-2xl animate-bounce";
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Carregar tela inicial
        renderSessions();
    </script>
</body>
</html>