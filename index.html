<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASMETO 2026 - Gestor de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-black-italic { font-weight: 900; font-style: italic; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="app" class="min-h-screen pb-12">
        <!-- O conteúdo será injetado pelo JavaScript -->
    </div>

    <script>
        // --- Estado Global ---
        const STORAGE_KEY = 'asmeto_players_v4';

        function loadInitialState() {
            const savedPlayers = localStorage.getItem(STORAGE_KEY);
            return {
                view: 'setup',
                players: savedPlayers ? JSON.parse(savedPlayers) : [],
                confirmedIds: [], 
                newPlayerName: '',
                playersPerTeam: 7, // Alterado para 7 conforme solicitado
                teamA: [],
                teamB: [],
                waitingList: [],
                scoreA: 0,
                scoreB: 0,
                timer: 600,
                isActive: false,
                matchCount: 0,
                showEventModal: null,
                eventType: null,
                selectedPlayerId: null,
                subModal: null
            };
        }

        let state = loadInitialState();
        let timerInterval = null;

        // --- Funções de Persistência ---
        function savePlayersToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.players));
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <nav class="bg-white border-b border-gray-100 sticky top-0 z-40 px-6 py-5 shadow-sm">
                    <div class="max-w-md mx-auto flex justify-between items-center">
                        <div class="flex flex-col">
                            <h1 class="text-2xl font-black-italic tracking-tighter text-green-700 leading-none">ASMETO</h1>
                            <span class="text-[8px] font-black uppercase tracking-[0.4em] text-green-500/60 mt-1">TEMPORADA 2026</span>
                        </div>
                        <div class="bg-gray-100 p-1.5 rounded-2xl flex gap-1">
                            <button onclick="changeView('setup')" class="p-2.5 rounded-xl transition-all ${state.view === 'setup' ? 'bg-white shadow-sm text-green-700' : 'text-gray-400'}"><i data-lucide="settings"></i></button>
                            <button onclick="changeView('match')" class="p-2.5 rounded-xl transition-all ${state.view === 'match' ? 'bg-white shadow-sm text-green-700' : 'text-gray-400'}"><i data-lucide="timer"></i></button>
                            <button onclick="changeView('ranking')" class="p-2.5 rounded-xl transition-all ${state.view === 'ranking' ? 'bg-white shadow-sm text-green-700' : 'text-gray-400'}"><i data-lucide="trophy"></i></button>
                        </div>
                    </div>
                </nav>
                <main class="max-w-md mx-auto p-4 animate-fade-in">
                    ${state.view === 'setup' ? renderSetup() : state.view === 'match' ? renderMatch() : renderRanking()}
                </main>
                ${renderModals()}
            `;
            lucide.createIcons();
        }

        function changeView(view) {
            state.view = view;
            render();
        }

        // --- Lógica de Jogadores ---
        function addPlayer(fromMatch = false) {
            const name = state.newPlayerName.trim();
            if (!name) return;
            const player = {
                id: Date.now(),
                name: name,
                goals: 0, assists: 0, yellowCards: 0, redCards: 0, wins: 0, matches: 0
            };
            state.players.push(player);
            state.newPlayerName = '';
            
            if (fromMatch) {
                state.waitingList.push(player);
                // Se algum time estiver incompleto, completa automaticamente
                fillIncompleteTeams();
            } else {
                state.confirmedIds.push(player.id);
            }
            
            savePlayersToStorage();
            render();
        }

        function fillIncompleteTeams() {
            while (state.waitingList.length > 0) {
                if (state.teamA.length < state.playersPerTeam) {
                    state.teamA.push(state.waitingList.shift());
                } else if (state.teamB.length < state.playersPerTeam) {
                    state.teamB.push(state.waitingList.shift());
                } else {
                    break;
                }
            }
        }

        function removeFromMatch(teamLabel, playerId) {
            if (!confirm("Remover este jogador da partida atual (ausência)?")) return;
            
            if (teamLabel === 'A') {
                state.teamA = state.teamA.filter(p => p.id !== playerId);
            } else if (teamLabel === 'B') {
                state.teamB = state.teamB.filter(p => p.id !== playerId);
            } else {
                state.waitingList = state.waitingList.filter(p => p.id !== playerId);
            }
            
            // Tenta repor com alguém da espera
            fillIncompleteTeams();
            render();
        }

        function startMatch() {
            const activePlayers = state.players.filter(p => state.confirmedIds.includes(p.id));
            const shuffled = [...activePlayers].sort(() => Math.random() - 0.5);
            state.teamA = shuffled.slice(0, state.playersPerTeam);
            state.teamB = shuffled.slice(state.playersPerTeam, state.playersPerTeam * 2);
            state.waitingList = shuffled.slice(state.playersPerTeam * 2);
            state.view = 'match';
            render();
        }

        function finishMatch(winner) {
            const winners = winner === 'A' ? state.teamA : state.teamB;
            const losers = winner === 'A' ? state.teamB : state.teamA;

            state.players.forEach(p => {
                if (winners.some(w => w.id === p.id)) { p.wins++; p.matches++; }
                else if (losers.some(l => l.id === p.id)) { p.matches++; }
            });

            state.matchCount++;
            let nextTeam = [];
            let remainingLosers = [...losers];

            // Pega da fila primeiro
            const needed = state.playersPerTeam;
            nextTeam = state.waitingList.slice(0, needed);
            state.waitingList = state.waitingList.slice(needed);

            // Se faltar gente, completa com quem perdeu (quem saiu)
            if (nextTeam.length < needed) {
                const stillNeeded = needed - nextTeam.length;
                const takenFromLosers = remainingLosers.slice(0, stillNeeded);
                remainingLosers = remainingLosers.slice(stillNeeded);
                nextTeam = [...nextTeam, ...takenFromLosers];
            }

            // O resto dos perdedores vai para o fim da fila
            state.waitingList = [...state.waitingList, ...remainingLosers];

            if (winner === 'A') state.teamB = nextTeam;
            else state.teamA = nextTeam;

            state.scoreA = 0; state.scoreB = 0;
            state.timer = 600;
            toggleTimer(false);
            savePlayersToStorage();
            render();
        }

        // --- Renderização de Telas ---

        function renderSetup() {
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-br from-green-600 to-green-900 p-6 rounded-[32px] text-white shadow-xl flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-black-italic">CONFIGURAÇÃO</h2>
                            <p class="text-green-100 text-[10px] uppercase font-bold tracking-widest">Ajuste os times e presença</p>
                        </div>
                        <div class="text-right">
                             <span class="text-3xl font-black italic">${state.playersPerTeam}</span>
                             <p class="text-[8px] font-bold uppercase">Jogadores/Time</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <div class="flex gap-2">
                            <input type="text" placeholder="Nome do atleta..." 
                                oninput="state.newPlayerName = this.value" value="${state.newPlayerName}"
                                class="flex-1 p-4 bg-gray-50 border border-gray-200 rounded-2xl outline-none font-medium focus:ring-2 focus:ring-green-500 transition-all">
                            <button onclick="addPlayer()" class="bg-green-600 text-white px-5 rounded-2xl shadow-lg active:scale-95"><i data-lucide="user-plus"></i></button>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-5 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                            <h3 class="font-black text-xs uppercase text-gray-400">Marcar Presença (${state.confirmedIds.length})</h3>
                            <div class="flex gap-2">
                                <button onclick="state.playersPerTeam = Math.max(2, state.playersPerTeam-1); render()" class="p-1 bg-gray-200 rounded">-</button>
                                <button onclick="state.playersPerTeam = Math.min(11, state.playersPerTeam+1); render()" class="p-1 bg-gray-200 rounded">+</button>
                            </div>
                        </div>
                        <div class="max-h-80 overflow-y-auto custom-scrollbar p-2">
                            ${state.players.map(p => {
                                const isConfirmed = state.confirmedIds.includes(p.id);
                                return `
                                    <div class="flex items-center gap-3 p-2">
                                        <button onclick="togglePresence(${p.id})" class="flex-1 flex items-center gap-3 text-left">
                                            <div class="w-5 h-5 rounded border-2 flex items-center justify-center ${isConfirmed ? 'bg-green-600 border-green-600 text-white' : 'border-gray-200'}">
                                                ${isConfirmed ? '<i data-lucide="check" size="12"></i>' : ''}
                                            </div>
                                            <span class="font-bold uppercase italic text-xs ${isConfirmed ? 'text-green-900' : 'text-gray-400'}">${p.name}</span>
                                        </button>
                                        <button onclick="removePlayerFromDB(${p.id})" class="text-gray-300 hover:text-red-500 px-2"><i data-lucide="trash-2" size="14"></i></button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <button onclick="startMatch()" class="w-full bg-zinc-900 text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest active:scale-95 transition-all">
                        Sortear Times (${state.playersPerTeam} x ${state.playersPerTeam})
                    </button>
                </div>
            `;
        }

        function renderMatch() {
            const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            return `
                <div class="space-y-6">
                    <!-- Painel de Placar -->
                    <div class="bg-zinc-900 text-white p-6 rounded-[32px] shadow-2xl relative">
                        <div class="flex justify-between items-center mb-4">
                             <div class="text-center flex-1">
                                <p class="text-[10px] font-black text-green-500 uppercase">TIME A</p>
                                <p class="text-6xl font-black-italic">${state.scoreA}</p>
                                <div class="flex justify-center gap-1 mt-2">
                                    <button onclick="openEvent('A', 'goal')" class="bg-green-600 p-2 rounded-lg"><i data-lucide="plus" size="16"></i></button>
                                    <button onclick="openEvent('A', 'yellow')" class="bg-yellow-500 p-2 rounded-lg text-black"><i data-lucide="copy" size="16"></i></button>
                                    <button onclick="openEvent('A', 'red')" class="bg-red-600 p-2 rounded-lg"><i data-lucide="copy" size="16"></i></button>
                                </div>
                             </div>
                             <div class="text-center px-4">
                                <p class="text-2xl font-mono font-bold text-green-400">${formatTime(state.timer)}</p>
                                <button onclick="toggleTimer()" class="mt-2 p-2 bg-zinc-800 rounded-full inline-block">
                                    <i data-lucide="${state.isActive ? 'pause' : 'play'}" size="20"></i>
                                </button>
                             </div>
                             <div class="text-center flex-1">
                                <p class="text-[10px] font-black text-blue-500 uppercase">TIME B</p>
                                <p class="text-6xl font-black-italic">${state.scoreB}</p>
                                <div class="flex justify-center gap-1 mt-2">
                                    <button onclick="openEvent('B', 'goal')" class="bg-blue-600 p-2 rounded-lg"><i data-lucide="plus" size="16"></i></button>
                                    <button onclick="openEvent('B', 'yellow')" class="bg-yellow-500 p-2 rounded-lg text-black"><i data-lucide="copy" size="16"></i></button>
                                    <button onclick="openEvent('B', 'red')" class="bg-red-600 p-2 rounded-lg"><i data-lucide="copy" size="16"></i></button>
                                </div>
                             </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="finishMatch('A')" class="flex-1 bg-green-900/50 text-green-400 border border-green-700/50 py-2 rounded-xl text-[10px] font-black uppercase">Fim de Jogo: Vitória A</button>
                            <button onclick="finishMatch('B')" class="flex-1 bg-blue-900/50 text-blue-400 border border-blue-700/50 py-2 rounded-xl text-[10px] font-black uppercase">Fim de Jogo: Vitória B</button>
                        </div>
                    </div>

                    <!-- Gestão de Times -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${renderLiveTeamCard('A', state.teamA)}
                        ${renderLiveTeamCard('B', state.teamB)}
                    </div>

                    <!-- Adicionar Jogador "Na Hora" -->
                    <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-2 italic">Chegou alguém agora?</p>
                        <div class="flex gap-2">
                            <input type="text" placeholder="Nome do jogador atrasado..." 
                                oninput="state.newPlayerName = this.value" value="${state.newPlayerName}"
                                class="flex-1 p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm">
                            <button onclick="addPlayer(true)" class="bg-zinc-800 text-white px-4 rounded-xl active:scale-95"><i data-lucide="user-plus" size="18"></i></button>
                        </div>
                    </div>

                    <!-- Fila de Espera -->
                    <div class="bg-amber-50 p-6 rounded-[32px] border border-amber-100">
                        <h4 class="font-black text-amber-800 mb-4 text-[10px] uppercase tracking-widest flex items-center gap-2"><i data-lucide="clock" size="14"></i> ESPERA (${state.waitingList.length})</h4>
                        <div class="flex flex-wrap gap-2">
                            ${state.waitingList.map((p) => `
                                <span class="px-3 py-1.5 bg-white rounded-xl text-[10px] font-black italic uppercase border border-amber-200 text-amber-900 flex items-center gap-2">
                                    ${p.name}
                                    <button onclick="removeFromMatch('W', ${p.id})" class="text-red-400"><i data-lucide="x" size="12"></i></button>
                                </span>
                            `).join('')}
                            ${state.waitingList.length === 0 ? '<p class="text-amber-600/50 text-[10px] font-bold">Ninguém aguardando.</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLiveTeamCard(label, team) {
            const color = label === 'A' ? 'text-green-600' : 'text-blue-600';
            const bgColor = label === 'A' ? 'bg-green-50/50' : 'bg-blue-50/50';
            const border = label === 'A' ? 'border-green-100' : 'border-blue-100';
            
            return `
                <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                         <h4 class="font-black text-gray-400 text-[10px] uppercase tracking-tighter">TIME ${label}</h4>
                         <span class="text-[10px] font-black ${color}">${team.length}/${state.playersPerTeam}</span>
                    </div>
                    <div class="space-y-1.5">
                        ${team.map(p => `
                            <div class="flex justify-between items-center p-2.5 ${bgColor} border ${border} rounded-xl group">
                                <span class="font-black text-gray-800 italic uppercase text-[11px] truncate">${p.name}</span>
                                <div class="flex gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openSubModal('${label}', ${p.id})" class="p-1.5 bg-white rounded-lg text-amber-600"><i data-lucide="refresh-cw" size="12"></i></button>
                                    <button onclick="removeFromMatch('${label}', ${p.id})" class="p-1.5 bg-white rounded-lg text-red-500"><i data-lucide="user-minus" size="12"></i></button>
                                </div>
                            </div>
                        `).join('')}
                        ${team.length < state.playersPerTeam ? `<div class="p-3 border-2 border-dashed border-gray-100 rounded-xl text-center text-[10px] text-gray-300 font-bold uppercase italic">Vaga em Aberto</div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderRanking() {
            const sorted = [...state.players].sort((a,b) => {
                const aprA = a.matches > 0 ? (a.wins/a.matches) : 0;
                const aprB = b.matches > 0 ? (b.wins/b.matches) : 0;
                if(aprB !== aprA) return aprB - aprA;
                return b.goals - a.goals;
            });

            return `
                <div class="space-y-4">
                    <h2 class="text-xl font-black-italic uppercase flex items-center gap-2"><i data-lucide="award" class="text-yellow-500"></i> ESTATÍSTICAS</h2>
                    <div class="bg-zinc-900 rounded-[32px] overflow-x-auto shadow-2xl border border-zinc-800">
                        <table class="w-full text-zinc-300 text-[10px]">
                            <thead class="bg-zinc-800 text-zinc-500 font-black uppercase tracking-widest">
                                <tr>
                                    <th class="px-4 py-4 text-left">Atleta</th>
                                    <th class="px-2 py-4 text-center">G</th>
                                    <th class="px-2 py-4 text-center">A</th>
                                    <th class="px-2 py-4 text-center text-yellow-500 italic">AM</th>
                                    <th class="px-2 py-4 text-center text-red-500 italic">VM</th>
                                    <th class="px-2 py-4 text-center">Vit</th>
                                    <th class="px-4 py-4 text-right">Apr</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-zinc-800">
                                ${sorted.filter(p => p.matches > 0).map((p) => `
                                    <tr class="hover:bg-zinc-800/50">
                                        <td class="px-4 py-4 font-black uppercase italic">${p.name}</td>
                                        <td class="px-2 py-4 text-center font-black text-green-500">${p.goals}</td>
                                        <td class="px-2 py-4 text-center font-black text-blue-500">${p.assists}</td>
                                        <td class="px-2 py-4 text-center font-black text-yellow-500">${p.yellowCards}</td>
                                        <td class="px-2 py-4 text-center font-black text-red-500">${p.redCards}</td>
                                        <td class="px-2 py-4 text-center font-black text-amber-500">${p.wins}</td>
                                        <td class="px-4 py-4 text-right font-black italic text-zinc-500">${p.matches > 0 ? Math.round((p.wins/p.matches)*100) : 0}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- Modais e Lógica de Eventos ---

        function openEvent(teamLabel, type) {
            state.showEventModal = teamLabel;
            state.eventType = type;
            state.selectedPlayerId = null;
            render();
        }

        function handleEventSelection(playerId) {
            state.selectedPlayerId = playerId;
            if (state.eventType !== 'goal') {
                registerEvent(null);
            } else {
                render();
            }
        }

        function registerEvent(assistId) {
            const playerId = state.selectedPlayerId;
            const type = state.eventType;
            const team = state.showEventModal;

            state.players = state.players.map(p => {
                if (p.id === playerId) {
                    if (type === 'goal') {
                        p.goals++;
                        if (team === 'A') state.scoreA++; else state.scoreB++;
                    }
                    if (type === 'yellow') p.yellowCards++;
                    if (type === 'red') p.redCards++;
                }
                if (type === 'goal' && assistId && p.id === assistId) p.assists++;
                return p;
            });

            state.showEventModal = null;
            state.eventType = null;
            state.selectedPlayerId = null;
            savePlayersToStorage();
            render();
        }

        function renderModals() {
            let html = '';
            if (state.showEventModal) {
                const team = state.showEventModal === 'A' ? state.teamA : state.teamB;
                const title = { goal: 'QUEM MARCOU?', yellow: 'CARTÃO AMARELO', red: 'CARTÃO VERMELHO' }[state.eventType];
                
                html += `
                    <div class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
                        <div class="bg-white w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl animate-fade-in">
                            <div class="bg-zinc-900 p-6 text-white text-center font-black uppercase tracking-widest italic">${title}</div>
                            <div class="p-6 space-y-2">
                                ${!state.selectedPlayerId ? 
                                    team.map(p => `<button onclick="handleEventSelection(${p.id})" class="w-full p-4 bg-gray-50 rounded-2xl font-black uppercase italic text-left flex justify-between">${p.name} <i data-lucide="user"></i></button>`).join('') :
                                    `
                                    <p class="text-[10px] font-black text-gray-400 uppercase text-center mb-2 tracking-widest">Assistência de:</p>
                                    <button onclick="registerEvent(null)" class="w-full p-4 bg-gray-100 rounded-2xl font-black uppercase italic text-gray-400">Ninguém</button>
                                    ${team.filter(p => p.id !== state.selectedPlayerId).map(p => `
                                        <button onclick="registerEvent(${p.id})" class="w-full p-4 bg-blue-50 text-blue-900 rounded-2xl font-black uppercase italic flex justify-between border border-blue-100">${p.name} <i data-lucide="hand-helping"></i></button>
                                    `).join('')}
                                    `
                                }
                                <button onclick="state.showEventModal=null; render()" class="w-full text-gray-400 font-black py-4 uppercase text-[10px] tracking-widest mt-4">Cancelar</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (state.subModal) {
                const { player, teamName } = state.subModal;
                html += `
                    <div class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-4">
                        <div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl">
                             <h3 class="text-xl font-black-italic uppercase text-center mb-6">SUBSTITUIR</h3>
                             <p class="text-center text-xs font-bold text-gray-400 uppercase mb-2">Saindo:</p>
                             <div class="bg-zinc-900 p-4 rounded-2xl text-white text-center font-black italic mb-8">${player.name}</div>
                             <div class="space-y-3">
                                <button onclick="executeSub()" class="w-full bg-amber-500 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95">Confirmar com o Próximo da Fila</button>
                                <button onclick="state.subModal=null; render()" class="w-full text-gray-400 font-bold py-2 uppercase text-[10px]">Fechar</button>
                             </div>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // --- Helpers ---
        function togglePresence(id) {
            state.confirmedIds = state.confirmedIds.includes(id) ? state.confirmedIds.filter(c => c !== id) : [...state.confirmedIds, id];
            render();
        }

        function removePlayerFromDB(id) {
            if(confirm("Excluir atleta?")) {
                state.players = state.players.filter(p => p.id !== id);
                state.confirmedIds = state.confirmedIds.filter(c => c !== id);
                savePlayersToStorage();
                render();
            }
        }

        function toggleTimer() {
            state.isActive = !state.isActive;
            if (state.isActive) {
                timerInterval = setInterval(() => {
                    if (state.timer > 0) { state.timer--; render(); } else { toggleTimer(); }
                }, 1000);
            } else { clearInterval(timerInterval); }
            render();
        }

        function openSubModal(teamName, playerId) {
            const team = teamName === 'A' ? state.teamA : state.teamB;
            const player = team.find(p => p.id === playerId);
            if(state.waitingList.length === 0) return alert("Fila de espera vazia!");
            state.subModal = { team, player, teamName };
            render();
        }

        function executeSub() {
            const { team, player, teamName } = state.subModal;
            const next = state.waitingList.shift();
            state.waitingList.push(player);
            const newTeam = team.map(p => p.id === player.id ? next : p);
            if (teamName === 'A') state.teamA = newTeam; else state.teamB = newTeam;
            state.subModal = null;
            render();
        }

        render();
    </script>
</body>
</html>