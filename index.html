<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASMETO 2026 - Gestor de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        .timer-glow { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .card-yellow { background-color: #fbbf24; }
        .card-red { background-color: #ef4444; }
        .suspended { filter: grayscale(1); opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900 mb-20">

    <!-- Header Principal -->
    <nav class="bg-green-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tighter">ASMETO 2026</h1>
            <div id="connection-status" class="text-xs bg-green-800 px-2 py-1 rounded">Aguardando Conex√£o...</div>
        </div>
    </nav>

    <div id="app" class="container mx-auto p-2 max-w-4xl">
        <!-- Navega√ß√£o por Abas -->
        <div class="flex border-b border-gray-300 mb-4 overflow-x-auto bg-white rounded-t-lg shadow-sm">
            <button onclick="switchTab('sessao')" class="tab-btn px-4 py-3 font-semibold text-green-700 border-b-2 border-green-700">Sess√£o</button>
            <button onclick="switchTab('cadastro')" class="tab-btn px-4 py-3 font-semibold text-gray-500">Atletas</button>
            <button onclick="switchTab('jogo')" class="tab-btn px-4 py-3 font-semibold text-gray-500">Match Day</button>
            <button onclick="switchTab('ranking')" class="tab-btn px-4 py-3 font-semibold text-gray-500">Ranking</button>
        </div>

        <!-- ABA 1: SESS√ÉO / HIST√ìRICO -->
        <div id="tab-sessao" class="tab-content block">
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h2 class="text-lg font-bold mb-3">Nova Pelada</h2>
                <div class="flex gap-2">
                    <input type="text" id="sessao-nome" placeholder="Ex: Pelada de Quarta" class="border p-2 rounded flex-1">
                    <button onclick="criarSessao()" class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700">Criar</button>
                </div>
            </div>
            
            <div id="lista-sessoes" class="space-y-2">
                <!-- Hist√≥rico ser√° carregado aqui -->
            </div>
        </div>

        <!-- ABA 2: CADASTRO E PRESEN√áA -->
        <div id="tab-cadastro" class="tab-content hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h2 class="text-lg font-bold mb-3">Cadastro de Atleta</h2>
                <div class="space-y-3">
                    <input type="text" id="atleta-nome" placeholder="Nome Completo" class="w-full border p-2 rounded">
                    
                    <div class="flex flex-col items-center gap-2">
                        <video id="video" class="w-full max-w-xs h-48 bg-black rounded" autoplay playsinline></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <button onclick="tirarFoto()" class="bg-blue-500 text-white px-4 py-2 rounded-full flex items-center gap-2">
                            <span>üì∏ Capturar Foto</span>
                        </button>
                        <img id="foto-preview" class="hidden w-24 h-24 rounded-full object-cover border-2 border-blue-500">
                    </div>

                    <button onclick="salvarAtleta()" class="w-full bg-green-600 text-white p-3 rounded font-bold">Cadastrar e Confirmar Presen√ßa</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-bold mb-3 font-bold">Lista de Presen√ßa / Inserir na Espera</h2>
                <div id="lista-presenca" class="divide-y">
                    <!-- Atletas confirmados aparecem aqui -->
                </div>
                <button onclick="iniciarSorteio()" class="mt-4 w-full bg-blue-600 text-white p-3 rounded font-bold">Gerar Sorteio Inicial (A vs B)</button>
            </div>
        </div>

        <!-- ABA 3: MATCH DAY (JOGO) -->
        <div id="tab-jogo" class="tab-content hidden">
            <!-- Cron√¥metro e Placar -->
            <div class="bg-gray-900 text-white p-6 rounded-xl shadow-2xl mb-4 text-center">
                <div id="timer" class="text-6xl font-mono timer-glow mb-4">10:00</div>
                <div class="flex justify-center gap-4 mb-4">
                    <button id="btn-timer-toggle" onclick="toggleTimer()" class="bg-green-600 px-6 py-2 rounded-lg font-bold">INICIAR</button>
                    <button onclick="resetTimer()" class="bg-gray-700 px-6 py-2 rounded-lg font-bold">RESET</button>
                </div>
                
                <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg">
                    <div class="text-center w-1/3">
                        <span class="block text-xs uppercase text-gray-400">Equipe A</span>
                        <span id="placar-a" class="text-5xl font-bold">0</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-600">VS</div>
                    <div class="text-center w-1/3">
                        <span class="block text-xs uppercase text-gray-400">Equipe B</span>
                        <span id="placar-b" class="text-5xl font-bold">0</span>
                    </div>
                </div>
            </div>

            <!-- Times em Campo -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-white p-3 rounded-lg shadow border-t-4 border-blue-500">
                    <h3 class="font-bold border-b pb-1 mb-2">Equipe A</h3>
                    <div id="campo-a" class="space-y-1"></div>
                    <button onclick="finalizarPartida('A')" class="mt-2 w-full bg-blue-100 text-blue-700 py-1 rounded text-sm font-bold">Vencedor A</button>
                </div>
                <div class="bg-white p-3 rounded-lg shadow border-t-4 border-red-500">
                    <h3 class="font-bold border-b pb-1 mb-2">Equipe B</h3>
                    <div id="campo-b" class="space-y-1"></div>
                    <button onclick="finalizarPartida('B')" class="mt-2 w-full bg-red-100 text-red-700 py-1 rounded text-sm font-bold">Vencedor B</button>
                </div>
            </div>

            <!-- Fila de Espera -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-bold mb-2 flex justify-between">
                    <span>Fila de Espera</span>
                    <span id="espera-count" class="text-xs bg-gray-200 px-2 py-1 rounded">0</span>
                </h3>
                <div id="fila-espera" class="flex gap-2 overflow-x-auto pb-2">
                    <!-- Jogadores em espera -->
                </div>
            </div>
            
            <!-- Suspensos -->
            <div id="area-suspensos" class="mt-4 hidden">
                <h3 class="font-bold text-red-600 mb-2">Puni√ß√µes em Tempo Real (VM)</h3>
                <div id="lista-suspensos" class="grid grid-cols-1 gap-2"></div>
            </div>
        </div>

        <!-- ABA 4: RANKING -->
        <div id="tab-ranking" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-2 text-xs">Atleta</th>
                            <th class="p-2 text-xs">GOL</th>
                            <th class="p-2 text-xs">AST</th>
                            <th class="p-2 text-xs">VIT</th>
                            <th class="p-2 text-xs text-center">APR%</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body" class="divide-y">
                        <!-- Ranking carregado aqui -->
                    </tbody>
                </table>
            </div>
            <button onclick="exportarEstatisticas()" class="mt-4 w-full bg-gray-800 text-white p-3 rounded font-bold">Exportar CSV Geral</button>
        </div>
    </div>

    <!-- MODAL: EVENTOS DE GOL -->
    <div id="modal-evento" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <h2 id="modal-titulo" class="text-xl font-bold mb-4">Registrar Gol</h2>
                <div id="modal-corpo" class="space-y-4">
                    <!-- Din√¢mico -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded mr-2">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Configura√ß√£o Firebase ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'asmeto-2026';

        // --- Estado Global ---
        let user = null;
        let atletas = [];
        let timeA = [];
        let timeB = [];
        let espera = [];
        let suspensos = [];
        let cronometro = { tempo: 600, ativo: false, interval: null };
        let ultimaFoto = null;

        // --- Autentica√ß√£o e Inicializa√ß√£o ---
        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autentica√ß√£o:", error);
                document.getElementById('connection-status').innerText = "Erro de Conex√£o";
                document.getElementById('connection-status').classList.replace('bg-green-800', 'bg-red-800');
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('connection-status').innerText = "Conectado";
                startListeners();
            }
        });

        function startListeners() {
            if (!user) return;

            // Ouvinte de Sess√µes
            const sessoesQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'sessoes'));
            onSnapshot(sessoesQuery, (snap) => {
                const lista = document.getElementById('lista-sessoes');
                lista.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    lista.innerHTML += `
                        <div class="bg-white p-3 rounded shadow flex justify-between items-center">
                            <div>
                                <h4 class="font-bold">${data.nome}</h4>
                                <p class="text-xs text-gray-400">${data.data ? new Date(data.data.seconds * 1000).toLocaleDateString() : 'Hoje'}</p>
                            </div>
                            <button class="text-green-600 font-bold">Abrir</button>
                        </div>
                    `;
                });
            }, (error) => console.error("Erro em sessoes:", error));

            // Ouvinte de Atletas
            const atletasQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'atletas'));
            onSnapshot(atletasQuery, (snap) => {
                atletas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const listaP = document.getElementById('lista-presenca');
                listaP.innerHTML = atletas.sort((a,b) => b.confirmado - a.confirmado || a.nome.localeCompare(b.nome)).map(a => {
                    // Verifica se j√° est√° em jogo ou na espera
                    const emJogoOuEspera = timeA.includes(a.id) || timeB.includes(a.id) || espera.includes(a.id);
                    
                    return `
                    <div class="flex justify-between items-center py-3">
                        <div class="flex items-center gap-3">
                            <img src="${a.foto || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border bg-gray-200 object-cover">
                            <div>
                                <span class="font-medium block">${a.nome}</span>
                                <span class="text-[10px] text-gray-500 uppercase">${emJogoOuEspera ? 'J√° em Atividade' : 'Dispon√≠vel'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${!emJogoOuEspera ? `<button onclick="adicionarDiretoEspera('${a.id}')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold border border-blue-200">+ Espera</button>` : ''}
                            <input type="checkbox" ${a.confirmado ? 'checked' : ''} onchange="toggleConfirmacao('${a.id}', this.checked)" class="h-6 w-6 text-green-600 rounded">
                        </div>
                    </div>
                `}).join('');
                
                carregarRanking();
            }, (error) => console.error("Erro em atletas:", error));

            // Ouvinte da Partida Atual
            const partidaRef = doc(db, 'artifacts', appId, 'public', 'data', 'partida_atual', 'status');
            onSnapshot(partidaRef, (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    timeA = data.timeA || [];
                    timeB = data.timeB || [];
                    espera = data.espera || [];
                    updateMatchUI(data);
                }
            }, (error) => console.error("Erro em partida:", error));

            // Ouvinte de Suspensos
            const suspensosQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'suspensos'));
            onSnapshot(suspensosQuery, (snap) => {
                suspensos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const listaS = document.getElementById('lista-suspensos');
                const areaS = document.getElementById('area-suspensos');
                
                if(suspensos.length > 0) {
                    areaS.classList.remove('hidden');
                    listaS.innerHTML = suspensos.map(s => {
                        const a = atletas.find(x => x.id === s.id);
                        const restante = Math.max(0, Math.ceil((s.expira - Date.now()) / 1000));
                        if(restante <= 0) removerSuspensao(s.id);
                        return `
                            <div class="flex justify-between items-center p-2 bg-red-100 rounded border border-red-200">
                                <span class="text-sm font-bold text-red-700">${a ? a.nome : 'Jogador'}</span>
                                <span class="text-xs font-mono bg-red-600 text-white px-2 py-1 rounded">${restante}s restantes</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    areaS.classList.add('hidden');
                }
            }, (error) => console.error("Erro em suspensos:", error));
        }

        // --- Fun√ß√µes de A√ß√£o ---

        window.toggleConfirmacao = async (id, status) => {
            const atRef = doc(db, 'artifacts', appId, 'public', 'data', 'atletas', id);
            await updateDoc(atRef, { confirmado: status });
        };

        window.adicionarDiretoEspera = async (id) => {
            const partidaRef = doc(db, 'artifacts', appId, 'public', 'data', 'partida_atual', 'status');
            const snap = await getDoc(partidaRef);
            if(!snap.exists()) {
                // Caso n√£o exista partida, cria com o jogador na espera
                await setDoc(partidaRef, { timeA: [], timeB: [], espera: [id], placarA: 0, placarB: 0 });
            } else {
                const data = snap.data();
                const novaEspera = [...(data.espera || [])];
                if(!novaEspera.includes(id)) {
                    novaEspera.push(id);
                    await updateDoc(partidaRef, { espera: novaEspera });
                }
            }
            alert("Atleta adicionado ao final da fila de espera!");
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('text-green-700', 'border-b-2', 'border-green-700');
                b.classList.add('text-gray-500');
            });
            const target = document.getElementById(`tab-${tabId}`);
            if (target) target.classList.remove('hidden');
            
            const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase().includes(tabId === 'sessao' ? 'sess√£o' : tabId));
            if(btn) btn.classList.add('text-green-700', 'border-b-2', 'border-green-700');
            
            if(tabId === 'cadastro') startCamera();
            else stopCamera();
        };

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('foto-preview');

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) { console.warn("C√¢mera indispon√≠vel:", err); }
        }

        function stopCamera() {
            if(video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        window.tirarFoto = () => {
            if(!video.srcObject) return alert("C√¢mera n√£o iniciada.");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            ultimaFoto = canvas.toDataURL('image/webp');
            preview.src = ultimaFoto;
            preview.classList.remove('hidden');
        };

        window.salvarAtleta = async () => {
            if (!user) return alert("Aguarde a conex√£o...");
            const nome = document.getElementById('atleta-nome').value;
            if(!nome) return alert("Digite o nome");
            
            const novoAtleta = {
                nome,
                foto: ultimaFoto || '',
                gols: 0,
                ast: 0,
                ca: 0,
                cv: 0,
                vitorias: 0,
                partidas: 0,
                confirmado: true,
                posicao: Date.now()
            };

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'atletas'), novoAtleta);
            document.getElementById('atleta-nome').value = '';
            preview.classList.add('hidden');
            ultimaFoto = null;
        };

        window.iniciarSorteio = async () => {
            if (!user) return;
            const confirmados = atletas.filter(a => a.confirmado).sort((a, b) => a.posicao - b.posicao);
            if(confirmados.length < 14) return alert("Necess√°rio ao menos 14 atletas confirmados para sorteio inicial (7 vs 7).");
            
            const numPorTime = 7;
            const sorteadosA = confirmados.slice(0, numPorTime);
            const sorteadosB = confirmados.slice(numPorTime, numPorTime * 2);
            const sorteadosEspera = confirmados.slice(numPorTime * 2);

            const partidaRef = doc(db, 'artifacts', appId, 'public', 'data', 'partida_atual', 'status');
            await setDoc(partidaRef, {
                timeA: sorteadosA.map(a => a.id),
                timeB: sorteadosB.map(a => a.id),
                espera: sorteadosEspera.map(a => a.id),
                placarA: 0,
                placarB: 0,
                consecutivasA: 0,
                consecutivasB: 0
            });
            
            switchTab('jogo');
        };

        function updateMatchUI(data) {
            const renderAtleta = (id, equipe) => {
                const a = atletas.find(x => x.id === id);
                if(!a) return '';
                const isSuspenso = suspensos.some(s => s.id === id);
                return `
                    <div class="flex items-center justify-between p-2 border rounded ${isSuspenso ? 'bg-red-50 border-red-200' : 'bg-gray-50'}">
                        <div class="flex items-center gap-2">
                            <img src="${a.foto || 'https://via.placeholder.com/32'}" class="w-8 h-8 rounded-full bg-gray-300 object-cover">
                            <span class="text-sm font-medium ${isSuspenso ? 'line-through text-red-400' : ''}">${a.nome}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="abrirModalGol('${id}', '${equipe}')" title="Gol" class="bg-green-500 text-white w-6 h-6 rounded text-xs">G</button>
                            <button onclick="darCartao('${id}', 'CA')" title="Amarelo" class="card-yellow text-white w-6 h-6 rounded text-xs">A</button>
                            <button onclick="darCartao('${id}', 'CV')" title="Vermelho" class="card-red text-white w-6 h-6 rounded text-xs">V</button>
                            <button onclick="substituir('${id}', '${equipe}')" title="Substituir" class="bg-gray-400 text-white w-6 h-6 rounded text-xs">üîÑ</button>
                        </div>
                    </div>
                `;
            };

            document.getElementById('campo-a').innerHTML = (data.timeA || []).map(id => renderAtleta(id, 'A')).join('');
            document.getElementById('campo-b').innerHTML = (data.timeB || []).map(id => renderAtleta(id, 'B')).join('');
            document.getElementById('placar-a').innerText = data.placarA || 0;
            document.getElementById('placar-b').innerText = data.placarB || 0;
            
            document.getElementById('fila-espera').innerHTML = (data.espera || []).map(id => {
                const a = atletas.find(x => x.id === id);
                return a ? `
                    <div class="min-w-[80px] text-center relative">
                        <button onclick="removerDaEspera('${id}')" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-[10px] flex items-center justify-center">√ó</button>
                        <img src="${a.foto || 'https://via.placeholder.com/48'}" class="w-12 h-12 rounded-full mx-auto border-2 border-gray-200 object-cover">
                        <p class="text-[10px] truncate px-1 mt-1 font-medium">${a.nome}</p>
                    </div>
                ` : '';
            }).join('');
            document.getElementById('espera-count').innerText = (data.espera || []).length;
        }

        window.removerDaEspera = async (id) => {
            const partidaRef = doc(db, 'artifacts', appId, 'public', 'data', 'partida_atual', 'status');
            const snap = await getDoc(partidaRef);
            if(snap.exists()){
                const d = snap.data();
                const novaEspera = (d.espera || []).filter(eid => eid !== id);
                await updateDoc(partidaRef, { espera: novaEspera });
            }
        };

        window.abrirModalGol = (atletaId, equipe) => {
            const idsTime = equipe === 'A' ? timeA : timeB;
            const assistentes = idsTime.filter(id => id !== atletaId);
            
            document.getElementById('modal-titulo').innerText = "Assist√™ncia?";
            let html = `<div class='grid grid-cols-1 gap-2'>`;
            assistentes.forEach(id => {
                const a = atletas.find(x => x.id === id);
                if(a) html += `<button onclick="registrarGol('${atletaId}', '${id}', '${equipe}')" class="p-3 border rounded text-left hover:bg-green-50">‚öΩ Assist: ${a.nome}</button>`;
            });
            html += `<button onclick="registrarGol('${atletaId}', null, '${equipe}')" class="p-3 border rounded text-left italic text-gray-400">Sem Assist√™ncia</button>`;
            html += `</div>`;
            
            document.getElementById('modal-corpo').innerHTML = html;
            openModal();
        };

        window.registrarGol = async (autorId, assistId, equipe) => {
            const partidaRef = doc(db, 'artifacts', appId, 'public', 'data', 'partida_atual', 'status');
            const snap = await getDoc(partidaRef);
            if(!snap.exists()) return;
            const pData = snap.data();
            
            const campoPlacar = `placar${equipe}`;
            await updateDoc(partidaRef, { [campoPlacar]: (pData[campoPlacar] || 0) + 1 });

            const autorRef = doc(db, 'artifacts', appId, 'public', 'data', 'atletas', autorId);
            const autor = atletas.find(x => x.id === autorId);
            if(autor) await updateDoc(autorRef, { gols: (autor.gols || 0) + 1 });

            if(assistId) {
                const assistRef = doc(db, 'artifacts', appId, 'public', 'data', 'atletas', assistId);
                const assist = atletas.find(x => x.id === assistId);
                if(assist) await updateDoc(assistRef, { ast: (assist.ast || 0) + 1 });
            }

            closeModal();
        };

        window.darCartao = async (id, tipo) => {
            const at = atletas.find(x => x.id === id);
            if(!at) return;
            const atRef = doc(db, 'artifacts', appId, 'public', 'data', 'atletas', id);
            
            if(tipo === 'CA') {
                const novosCA = (at.ca || 0) + 1;
                await updateDoc(atRef, { ca: novosCA });
                if(novosCA % 2 === 0) suspenderJogador(id);
            } else {
                await updateDoc(atRef, { cv: (at.cv || 0) + 1 });
                suspenderJogador(id);
            }
        };

        async function suspenderJogador(id) {
            const expira = Date.now() + (90 * 1000);
            const susRef = doc(db, 'artifacts', appId, 'public', 'data', 'suspensos', id);
            await setDoc(susRef, { id, expira });
        }

        async function removerSuspensao(id) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'suspensos', id));
        }

        window.substituir = async (saiId, equipe) => {
            const partidaRef = doc(db, 'artifacts', appId, 'public', 'data', 'partida_atual', 'status');
            const snap = await getDoc(partidaRef);
            if(!snap.exists()) return;
            const pData = snap.data();

            if(!pData.espera || pData.espera.length === 0) return alert("Fila de espera est√° vazia!");

            const entraId = pData.espera[0];
            const novaEspera = [...pData.espera.slice(1), saiId];

            const tA = equipe === 'A' ? pData.timeA.map(id => id === saiId ? entraId : id) : pData.timeA;
            const tB = equipe === 'B' ? pData.timeB.map(id => id === saiId ? entraId : id) : pData.timeB;

            await updateDoc(partidaRef, { timeA: tA, timeB: tB, espera: novaEspera });
        };

        window.finalizarPartida = async (vencedor) => {
            const partidaRef = doc(db, 'artifacts', appId, 'public', 'data', 'partida_atual', 'status');
            const snap = await getDoc(partidaRef);
            if(!snap.exists()) return;
            const pData = snap.data();

            const timeVence = vencedor === 'A' ? pData.timeA : pData.timeB;
            const timePerde = vencedor === 'A' ? pData.timeB : pData.timeA;
            
            for(let id of timeVence) {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'atletas', id);
                const at = atletas.find(x => x.id === id);
                if(at) await updateDoc(ref, { vitorias: (at.vitorias || 0) + 1, partidas: (at.partidas || 0) + 1 });
            }
            for(let id of timePerde) {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'atletas', id);
                const at = atletas.find(x => x.id === id);
                if(at) await updateDoc(ref, { partidas: (at.partidas || 0) + 1 });
            }

            let consec = (vencedor === 'A' ? pData.consecutivasA : pData.consecutivasB) + 1;
            let novaEspera = [...pData.espera, ...timePerde];
            let novoVence = timeVence;
            
            if(consec >= 3) {
                novaEspera = [...novaEspera, ...timeVence];
                novoVence = novaEspera.splice(0, 7);
                consec = 0;
            }
            const novoDesafiante = novaEspera.splice(0, 7);

            await updateDoc(partidaRef, {
                timeA: vencedor === 'A' ? novoVence : novoDesafiante,
                timeB: vencedor === 'B' ? novoVence : novoDesafiante,
                espera: novaEspera,
                placarA: 0, placarB: 0,
                consecutivasA: vencedor === 'A' ? consec : 0,
                consecutivasB: vencedor === 'B' ? consec : 0
            });
            
            resetTimer();
        };

        window.toggleTimer = () => {
            if(cronometro.ativo) {
                clearInterval(cronometro.interval);
                document.getElementById('btn-timer-toggle').innerText = "INICIAR";
                document.getElementById('btn-timer-toggle').className = "bg-green-600 px-6 py-2 rounded-lg font-bold";
            } else {
                cronometro.interval = setInterval(() => {
                    cronometro.tempo--;
                    if(cronometro.tempo <= 0) {
                        clearInterval(cronometro.interval);
                        cronometro.ativo = false;
                        alert("Tempo esgotado!");
                    }
                    updateTimerDisplay();
                }, 1000);
                document.getElementById('btn-timer-toggle').innerText = "PAUSAR";
                document.getElementById('btn-timer-toggle').className = "bg-red-600 px-6 py-2 rounded-lg font-bold";
            }
            cronometro.ativo = !cronometro.ativo;
        };

        window.resetTimer = () => {
            clearInterval(cronometro.interval);
            cronometro.tempo = 600;
            cronometro.ativo = false;
            updateTimerDisplay();
            document.getElementById('btn-timer-toggle').innerText = "INICIAR";
            document.getElementById('btn-timer-toggle').className = "bg-green-600 px-6 py-2 rounded-lg font-bold";
        };

        function updateTimerDisplay() {
            const m = Math.floor(cronometro.tempo / 60);
            const s = cronometro.tempo % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function carregarRanking() {
            const sorted = [...atletas].sort((a, b) => {
                const aprA = a.partidas ? (a.vitorias / a.partidas) : 0;
                const aprB = b.partidas ? (b.vitorias / b.partidas) : 0;
                return aprB - aprA || b.gols - a.gols;
            });
            document.getElementById('ranking-body').innerHTML = sorted.map(a => `
                <tr>
                    <td class="p-2 flex items-center gap-2">
                        <img src="${a.foto || 'https://via.placeholder.com/24'}" class="w-6 h-6 rounded-full bg-gray-200 object-cover">
                        <span class="text-sm truncate max-w-[100px]">${a.nome}</span>
                    </td>
                    <td class="p-2 text-center">${a.gols || 0}</td>
                    <td class="p-2 text-center">${a.ast || 0}</td>
                    <td class="p-2 text-center">${a.vitorias || 0}</td>
                    <td class="p-2 text-center font-bold text-green-600">${a.partidas ? Math.round((a.vitorias/a.partidas)*100) : 0}%</td>
                </tr>
            `).join('');
        }

        window.exportarEstatisticas = () => {
            let csv = "Nome,Gols,Assistencias,CA,CV,Vitorias,Partidas,Aproveitamento\n";
            atletas.forEach(a => {
                const apr = a.partidas ? Math.round((a.vitorias/a.partidas)*100) : 0;
                csv += `${a.nome},${a.gols},${a.ast},${a.ca},${a.cv},${a.vitorias},${a.partidas},${apr}%\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ranking_asmeto.csv`;
            link.click();
        };

        window.openModal = () => {
            const m = document.getElementById('modal-evento');
            m.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        };
        window.closeModal = () => {
            const m = document.getElementById('modal-evento');
            m.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        };

        window.criarSessao = async () => {
            const n = document.getElementById('sessao-nome').value;
            if(!n) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sessoes'), { nome: n, data: serverTimestamp() });
            document.getElementById('sessao-nome').value = '';
        };

        initApp();

        setInterval(() => {
            if(suspensos.length > 0) {
                const listaS = document.getElementById('lista-suspensos');
                if(listaS) {
                    const html = suspensos.map(s => {
                        const a = atletas.find(x => x.id === s.id);
                        const restante = Math.max(0, Math.ceil((s.expira - Date.now()) / 1000));
                        if(restante <= 0) { removerSuspensao(s.id); return ''; }
                        return `
                            <div class="flex justify-between items-center p-2 bg-red-100 rounded border border-red-200">
                                <span class="text-sm font-bold text-red-700">${a ? a.nome : 'Jogador'}</span>
                                <span class="text-xs font-mono bg-red-600 text-white px-2 py-1 rounded">${restante}s</span>
                            </div>
                        `;
                    }).join('');
                    listaS.innerHTML = html;
                }
            }
        }, 1000);

    </script>
</body>
</html>